{% extends "base.html" %}
{% block title %}–ê–¥–º—ñ–Ω –ø–∞–Ω–µ–ª—å - –ì–æ—Ç–µ–ª—å –•—Ä–µ—â–∞—Ç–∏–∫{% endblock %}

{% block content %}
<section class="page-header">
    <div class="container">
        <h1 class="page-title">–ê–¥–º—ñ–Ω –ø–∞–Ω–µ–ª—å</h1>
        <p class="page-subtitle">–£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è —Å–∏—Å—Ç–µ–º–æ—é</p>
    </div>
</section>

<section class="admin-section">
    <div class="container">
        <div class="admin-container">
            <div class="admin-welcome">
                <h2>–õ–∞—Å–∫–∞–≤–æ –ø—Ä–æ—Å–∏–º–æ, {{ user.first_name }}!</h2>
                <p>–í–∏ —É–≤—ñ–π—à–ª–∏ —è–∫ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä —Å–∏—Å—Ç–µ–º–∏</p>
            </div>
            
            <div class="admin-stats">
                <h3>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º–∏</h3>
                <div class="stats-filters">
                    <div class="filter-item">
                        <label for="stats-from">–í—ñ–¥</label>
                        <input type="date" id="stats-from">
                    </div>
                    <div class="filter-item">
                        <label for="stats-to">–î–æ</label>
                        <input type="date" id="stats-to">
                    </div>
                    <div class="filter-item">
                        <label style="visibility: hidden;">apply</label>
                        <button id="stats-apply" class="btn btn-primary">–ü–æ–∫–∞–∑–∞—Ç–∏</button>
                    </div>
                </div>
                <div class="stats-grid">
                    <div class="stat-card clickable" data-href="/users" title="–ü–µ—Ä–µ–π—Ç–∏ –¥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤">
                        <div class="stat-icon">üë•</div>
                        <div class="stat-info">
                            <h4>–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ</h4>
                            <p><span id="usersTotal">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</span></p>
                            <small class="muted">–ó–∞ –ø–µ—Ä—ñ–æ–¥: <span id="usersPeriod">‚Äî</span></small>
                        </div>
                    </div>
                    <div class="stat-card clickable" data-href="/rooms" title="–ü–µ—Ä–µ–π—Ç–∏ –¥–æ –Ω–æ–º–µ—Ä—ñ–≤">
                        <div class="stat-icon">üè®</div>
                        <div class="stat-info">
                            <h4>–ù–æ–º–µ—Ä–∏</h4>
                            <p id="roomsTotal">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</p>
                        </div>
                    </div>
                    <div class="stat-card clickable" data-href="/bookings" title="–ü–µ—Ä–µ–π—Ç–∏ –¥–æ –±—Ä–æ–Ω—é–≤–∞–Ω—å">
                        <div class="stat-icon">üìÖ</div>
                        <div class="stat-info">
                            <h4>–ë—Ä–æ–Ω—é–≤–∞–Ω–Ω—è</h4>
                            <p><span id="bookingsTotal">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</span></p>
                            <small class="muted">–ó–∞ –ø–µ—Ä—ñ–æ–¥: <span id="bookingsPeriod">‚Äî</span></small>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="admin-actions">
                <h3>–£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è</h3>
                <div class="action-grid">
                    <a href="/users" class="admin-btn">
                        <div class="admin-btn-icon">üë•</div>
                        <div class="admin-btn-text">
                            <h4>–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ</h4>
                            <p>–£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º–∏</p>
                        </div>
                    </a>
                    <a href="/rooms" class="admin-btn">
                        <div class="admin-btn-icon">üè®</div>
                        <div class="admin-btn-text">
                            <h4>–ù–æ–º–µ—Ä–∏</h4>
                            <p>–£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –Ω–æ–º–µ—Ä–∞–º–∏</p>
                        </div>
                    </a>
                    <a href="/bookings" class="admin-btn">
                        <div class="admin-btn-icon">üìÖ</div>
                        <div class="admin-btn-text">
                            <h4>–ë—Ä–æ–Ω—é–≤–∞–Ω–Ω—è</h4>
                            <p>–£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –±—Ä–æ–Ω—é–≤–∞–Ω–Ω—è–º–∏</p>
                        </div>
                    </a>
                    <a href="/api-docs" class="admin-btn">
                        <div class="admin-btn-icon">üìö</div>
                        <div class="admin-btn-text">
                            <h4>API –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—è</h4>
                            <p>–ü–µ—Ä–µ–≥–ª—è–¥ API</p>
                        </div>
                    </a>
                </div>
            </div>
        </div>
    </div>
</section>

<style>
.admin-section {
    padding: 60px 0;
    background-color: var(--gray-light);
}

.admin-container {
    max-width: 1000px;
    margin: 0 auto;
    background-color: var(--white);
    padding: 40px;
    border-radius: 8px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.admin-welcome {
    text-align: center;
    margin-bottom: 40px;
    padding-bottom: 30px;
    border-bottom: 2px solid var(--gold);
}

.admin-welcome h2 {
    color: var(--dark-blue);
    margin-bottom: 10px;
    font-size: 32px;
}

.admin-welcome p {
    color: var(--gray);
    font-size: 18px;
}

.admin-stats {
    margin-bottom: 40px;
}

.admin-stats h3 {
    color: var(--dark-blue);
    margin-bottom: 30px;
    font-size: 24px;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
}

.stat-card {
    background-color: var(--gray-light);
    padding: 25px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    gap: 15px;
    transition: transform 0.3s;
}

.stat-card:hover {
    transform: translateY(-5px);
}

.stat-card.clickable { cursor: pointer; }

.stats-filters{display:flex;gap:12px;align-items:flex-end;margin-bottom:12px}
.stats-filters .filter-item{display:flex;flex-direction:column}
.stats-filters input[type="date"]{height:36px}
.muted{color:var(--gray);font-size:12px}

.stat-icon {
    font-size: 32px;
    width: 50px;
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: var(--gold);
    border-radius: 50%;
}

.stat-info h4 {
    color: var(--dark-blue);
    margin-bottom: 5px;
    font-size: 16px;
}

.stat-info p {
    color: var(--gray);
    font-size: 14px;
    font-weight: 500;
}

.admin-actions h3 {
    color: var(--dark-blue);
    margin-bottom: 30px;
    font-size: 24px;
}

.action-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
}

.admin-btn {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 20px;
    background-color: var(--gray-light);
    border-radius: 8px;
    text-decoration: none;
    color: var(--dark-blue);
    transition: all 0.3s;
    border: 2px solid transparent;
}

.admin-btn:hover {
    background-color: var(--white);
    border-color: var(--gold);
    transform: translateY(-3px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.admin-btn-icon {
    font-size: 24px;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: var(--gold);
    border-radius: 50%;
}

.admin-btn-text h4 {
    margin-bottom: 5px;
    font-size: 16px;
}

.admin-btn-text p {
    color: var(--gray);
    font-size: 14px;
}

@media (max-width: 768px) {
    .stats-grid {
        grid-template-columns: 1fr;
    }
    
    .action-grid {
        grid-template-columns: 1fr;
    }
    
    .admin-btn {
        flex-direction: column;
        text-align: center;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', async function() {
    const token = (window.authManager && window.authManager.token) || localStorage.getItem('access_token') || null;
    const baseHeaders = token ? { 'Authorization': `Bearer ${token}` } : {};

    const usersTotalEl = document.getElementById('usersTotal');
    const usersPeriodEl = document.getElementById('usersPeriod');
    const roomsTotalEl = document.getElementById('roomsTotal');
    const bookingsTotalEl = document.getElementById('bookingsTotal');
    const bookingsPeriodEl = document.getElementById('bookingsPeriod');

    const fromInput = document.getElementById('stats-from');
    const toInput = document.getElementById('stats-to');
    const applyBtn = document.getElementById('stats-apply');

    // Defaults: this month
    const today = new Date();
    const firstMonthDay = new Date(today.getFullYear(), today.getMonth(), 1);
    fromInput.value = firstMonthDay.toISOString().slice(0,10);
    toInput.value = today.toISOString().slice(0,10);

    async function fetchList(url){
        try{
            let res = await fetch(url, { headers: baseHeaders });
            if(!res.ok){
                const altUrl = url.endsWith('/') ? url.slice(0,-1) : (url + '/');
                res = await fetch(altUrl, { headers: baseHeaders });
            }
            if(!res.ok) return [];
            const data = await res.json();
            return Array.isArray(data) ? data : [];
        }catch(_){ return []; }
    }

    async function loadStats(){
        const [users, rooms, bookings] = await Promise.all([
            fetchList('/api/v1/users'),
            fetchList('/api/v1/rooms'),
            fetchList('/api/v1/bookings')
        ]);

        usersTotalEl.textContent = users.length;
        roomsTotalEl.textContent = rooms.length;
        bookingsTotalEl.textContent = bookings.length;

        const from = new Date(fromInput.value);
        const to = new Date(toInput.value);
        if (isNaN(from) || isNaN(to) || to < from){
            usersPeriodEl.textContent = '‚Äî';
            bookingsPeriodEl.textContent = '‚Äî';
            return;
        }

        function inPeriod(d){
            if(!d) return false;
            const dt = new Date(d);
            if (isNaN(dt)) return false;
            return dt >= from && dt <= new Date(to.getFullYear(), to.getMonth(), to.getDate(), 23,59,59,999);
        }

        const usersNew = users.filter(u => inPeriod(u.created_at)).length;
        const bookingsInPeriod = bookings.filter(b => inPeriod(b.created_at)).length;

        usersPeriodEl.textContent = usersNew;
        bookingsPeriodEl.textContent = bookingsInPeriod;
    }

    await loadStats();
    applyBtn.addEventListener('click', (e)=>{ e.preventDefault(); loadStats(); });


    document.querySelectorAll('.stat-card.clickable').forEach(card => {
        card.addEventListener('click', () => {
            const href = card.getAttribute('data-href');
            if (href) window.location.href = href;
        });
    });
});
</script>
{% endblock %}
